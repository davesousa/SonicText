<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>SonicText Settings</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: var(--bg-color, #2c2c2c);
            color: var(--text-color, #ffffff);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            user-select: none;
            overflow-y: auto;
            overflow-x: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        :root {
            /* Dark theme (default) */
            --bg-color: #2c2c2c;
            --text-color: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.8);
            --text-hint: rgba(255, 255, 255, 0.5);
            --bg-group: rgba(255, 255, 255, 0.1);
            --bg-input: rgba(0, 0, 0, 0.2);
            --border-color: rgba(255, 255, 255, 0.1);
            --border-focus: rgba(255, 255, 255, 0.3);
            --scrollbar-track: rgba(255, 255, 255, 0.1);
            --scrollbar-thumb: rgba(255, 255, 255, 0.3);
            --scrollbar-thumb-hover: rgba(255, 255, 255, 0.4);
        }

        body.light-theme {
            /* Light theme */
            --bg-color: #f5f5f5;
            --text-color: #2c2c2c;
            --text-secondary: rgba(0, 0, 0, 0.8);
            --text-hint: rgba(0, 0, 0, 0.6);
            --bg-group: rgba(0, 0, 0, 0.05);
            --bg-input: #ffffff;
            --border-color: rgba(0, 0, 0, 0.1);
            --border-focus: rgba(0, 0, 0, 0.3);
            --scrollbar-track: rgba(0, 0, 0, 0.1);
            --scrollbar-thumb: rgba(0, 0, 0, 0.2);
            --scrollbar-thumb-hover: rgba(0, 0, 0, 0.3);
        }

        /* Custom scrollbar styling */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 4px;
            transition: background 0.2s;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .settings-container {
            max-width: none;
            width: 100%;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            grid-auto-rows: 1fr;  /* Make all rows the same height */
            gap: 16px;
            margin-top: 20px;
        }

        .header {
            position: sticky;
            top: 0;
            background: var(--bg-color);
            padding: 0 0 16px 0;
            z-index: 10;
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        h2 {
            margin: 0;
            color: var(--text-color);
            font-size: 18px;
            font-weight: 500;
        }

        .close-button {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            font-size: 20px;
            padding: 4px;
            line-height: 1;
            transition: color 0.2s;
            margin-left: auto;
        }

        .close-button:hover {
            color: var(--text-color);
        }

        .setting-group {
            background: var(--bg-group);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 0;
            height: 100%;  /* Fill the entire grid cell */
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
        }

        .setting-label {
            display: block;
            margin-bottom: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            flex-shrink: 0;  /* Prevent label from shrinking */
        }

        .hotkey-input, .device-select {
            width: calc(100% - 24px);
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 8px;
            box-sizing: border-box;
            flex-shrink: 0;  /* Prevent input from shrinking */
        }

        .device-select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="white" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 32px;
        }

        .device-select option {
            background: #2c2c2c;
            color: #ffffff;
            padding: 8px;
        }

        .device-select:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        .hint-text {
            font-size: 12px;
            color: var(--text-hint);
            margin-top: 4px;
            flex-shrink: 0;  /* Prevent hint text from shrinking */
        }

        .save-indicator {
            font-size: 12px;
            color: #4a9eff;
            margin-top: auto;  /* Push to bottom of flex container */
            padding-top: 8px;
            opacity: 0;
            transition: opacity 0.3s;
            flex-shrink: 0;  /* Prevent indicator from shrinking */
        }

        .save-indicator.visible {
            opacity: 1;
        }

        /* Add some placeholder settings groups for future settings */
        .setting-group.placeholder {
            opacity: 1;
        }

        .setting-group.placeholder .setting-label {
            color: var(--text-secondary);
        }

        .setting-group.placeholder .hint-text {
            font-style: normal;
        }

        .device-select:disabled {
            opacity: 0.7;
            cursor: not-allowed;
        }

        .settings-input {
            width: calc(100% - 24px);
            padding: 8px 12px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 4px;
            color: var(--text-color);
            font-size: 14px;
            margin-bottom: 8px;
            box-sizing: border-box;
            flex-shrink: 0;
        }

        .settings-input:focus {
            outline: none;
            border-color: var(--border-focus);
        }

        a {
            color: var(--border-focus);
            text-decoration: none;
        }

        a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="settings-container">
        <div class="header">
            <h2>Settings</h2>
            <button class="close-button" id="closeButton">Ã—</button>
        </div>
        <div class="settings-grid">
            <div class="setting-group">
                <label class="setting-label" for="hotkeyInput">Global Hotkey</label>
                <input type="text" id="hotkeyInput" class="hotkey-input" placeholder="Press keys..." readonly>
                <div class="hint-text">Click to change the hotkey combination</div>
            </div>
            <div class="setting-group">
                <label class="setting-label" for="apiKeyInput">OpenAI API Key</label>
                <input type="password" id="apiKeyInput" class="settings-input" placeholder="Enter your OpenAI API key">
                <div class="hint-text">Get your API key from: <a href="#" onclick="openApiKeyPage()">OpenAI Dashboard</a></div>
            </div>
            <div class="setting-group">
                <label class="setting-label" for="deviceSelect">Input Device</label>
                <select id="deviceSelect" class="device-select"></select>
                <div class="hint-text">Select your preferred microphone</div>
            </div>
            <div class="setting-group">
                <label class="setting-label" for="languageSelect">Language</label>
                <select id="languageSelect" class="device-select">
                    <option value="en">English</option>
                    <option value="es">Spanish</option>
                    <option value="fr">French</option>
                    <option value="de">German</option>
                    <option value="it">Italian</option>
                    <option value="pt">Portuguese</option>
                    <option value="nl">Dutch</option>
                    <option value="ja">Japanese</option>
                    <option value="ko">Korean</option>
                    <option value="zh">Chinese</option>
                </select>
                <div class="hint-text">Select transcription language</div>
            </div>
            <div class="setting-group">
                <label class="setting-label">Theme</label>
                <select id="themeSelect" class="device-select">
                    <option value="dark">Dark</option>
                    <option value="light">Light</option>
                </select>
                <div class="hint-text">Customize the app's appearance</div>
            </div>
            <div class="save-indicator" id="saveIndicator">Settings saved!</div>
        </div>
    </div>
    <script>
        const { ipcRenderer } = require('electron');
        const hotkeyInput = document.getElementById('hotkeyInput');
        const deviceSelect = document.getElementById('deviceSelect');
        const closeButton = document.getElementById('closeButton');
        const saveIndicator = document.getElementById('saveIndicator');
        const themeSelect = document.getElementById('themeSelect');
        const languageSelect = document.getElementById('languageSelect');
        const apiKeyInput = document.getElementById('apiKeyInput');
        let currentHotkey = '';
        let recordingKeys = false;
        let pressedKeys = new Set();
        let saveTimeout = null;

        // Get available audio devices
        async function loadAudioDevices() {
            try {
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioDevices = devices.filter(device => device.kind === 'audioinput');
                
                // Clear existing options
                deviceSelect.innerHTML = '';
                
                // Add devices to select
                audioDevices.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${device.deviceId.slice(0, 5)}...`;
                    deviceSelect.appendChild(option);
                });

                // Get current device from main process
                ipcRenderer.send('get-current-device');
            } catch (error) {
                console.error('Error loading audio devices:', error);
                deviceSelect.innerHTML = '<option value="">Error loading devices</option>';
            }
        }

        function showSaveIndicator() {
            saveIndicator.classList.add('visible');
            if (saveTimeout) clearTimeout(saveTimeout);
            saveTimeout = setTimeout(() => {
                saveIndicator.classList.remove('visible');
            }, 2000);
        }

        // Load devices when permissions are granted
        navigator.mediaDevices.getUserMedia({ audio: true })
            .then(() => loadAudioDevices())
            .catch(error => {
                console.error('Error getting audio permissions:', error);
                deviceSelect.innerHTML = '<option value="">No microphone access</option>';
            });

        // Handle device selection
        deviceSelect.addEventListener('change', () => {
            const deviceId = deviceSelect.value;
            ipcRenderer.send('update-device', deviceId);
            showSaveIndicator();
        });

        // Get current device from main process
        ipcRenderer.on('current-device', (event, deviceId) => {
            if (deviceId && deviceSelect.querySelector(`option[value="${deviceId}"]`)) {
                deviceSelect.value = deviceId;
            }
        });

        // Handle hotkey recording
        hotkeyInput.addEventListener('focus', () => {
            recordingKeys = true;
            pressedKeys.clear();
            hotkeyInput.value = '';
        });

        hotkeyInput.addEventListener('blur', () => {
            recordingKeys = false;
            if (!hotkeyInput.value) {
                hotkeyInput.value = currentHotkey;
            }
        });

        document.addEventListener('keydown', (e) => {
            if (!recordingKeys) return;
            e.preventDefault();

            const key = e.key.toLowerCase();
            const keyMap = {
                'control': 'CommandOrControl',
                'meta': 'CommandOrControl',
                'alt': 'Alt',
                'shift': 'Shift',
                'escape': 'Esc',
                'return': 'Return',
                'enter': 'Return',
                ' ': 'Space'
            };

            const mappedKey = keyMap[key] || key.length === 1 ? key.toUpperCase() : key;
            
            if (key === 'control' || key === 'shift' || key === 'alt' || key === 'meta' || key.length === 1 || keyMap[key]) {
                pressedKeys.add(mappedKey);
            }

            const keys = Array.from(pressedKeys);
            if (keys.length > 0) {
                hotkeyInput.value = keys.join('+');
            }
        });

        document.addEventListener('keyup', (e) => {
            if (!recordingKeys) return;
            const key = e.key.toLowerCase();
            const keyMap = {
                'control': 'CommandOrControl',
                'meta': 'CommandOrControl',
                'alt': 'Alt',
                'shift': 'Shift',
                'escape': 'Esc',
                'return': 'Return',
                'enter': 'Return',
                ' ': 'Space'
            };
            const mappedKey = keyMap[key] || key.length === 1 ? key.toUpperCase() : key;
            pressedKeys.delete(mappedKey);

            if (pressedKeys.size === 0 && hotkeyInput.value && hotkeyInput.value !== currentHotkey) {
                const newHotkey = hotkeyInput.value;
                currentHotkey = newHotkey;
                ipcRenderer.send('update-hotkey', newHotkey);
                showSaveIndicator();
            }
        });

        // Get current hotkey
        ipcRenderer.send('get-current-hotkey');
        ipcRenderer.on('current-hotkey', (event, hotkey) => {
            currentHotkey = hotkey;
            hotkeyInput.value = hotkey;
        });

        // Handle theme changes
        themeSelect.addEventListener('change', () => {
            const theme = themeSelect.value;
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
            ipcRenderer.send('update-theme', theme);
            showSaveIndicator();
        });

        // Handle language changes
        languageSelect.addEventListener('change', () => {
            const language = languageSelect.value;
            ipcRenderer.send('update-language', language);
            showSaveIndicator();
        });

        // Get current theme and language
        ipcRenderer.send('get-theme');
        ipcRenderer.send('get-language');

        ipcRenderer.on('current-theme', (event, theme) => {
            themeSelect.value = theme;
            if (theme === 'light') {
                document.body.classList.add('light-theme');
            } else {
                document.body.classList.remove('light-theme');
            }
        });

        ipcRenderer.on('current-language', (event, language) => {
            languageSelect.value = language || 'en';
        });

        // Handle API key
        ipcRenderer.send('get-api-key');
        
        ipcRenderer.on('current-api-key', (event, apiKey) => {
            apiKeyInput.value = apiKey || '';
        });

        apiKeyInput.addEventListener('input', () => {
            ipcRenderer.send('update-api-key', apiKeyInput.value);
            showSaveIndicator();
        });

        // Handle close button
        closeButton.addEventListener('click', () => {
            ipcRenderer.send('close-settings');
        });

        function openApiKeyPage() {
            require('electron').shell.openExternal('https://platform.openai.com/api-keys');
        }
    </script>
</body>
</html> 